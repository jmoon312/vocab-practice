<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moon spelling practice</title>
  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 20px; }
    .card { background: white; border: 1px solid #e6e8f0; border-radius: 14px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,.04); }
    h1 { margin: 0 0 12px; font-size: 22px; }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label { display: block; font-weight: 600; margin: 10px 0 6px; }
    input, select, button {
      width: 100%; box-sizing: border-box;
      border: 1px solid #d7daea; border-radius: 12px;
      padding: 12px 14px; font-size: 18px;
      background: #fff;
    }
    button { font-weight: 700; cursor: pointer; }
    button.primary { background: #1b4ddb; color: #fff; border-color: #1b4ddb; }
    button.secondary { background: #fff; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { color: #5a617a; font-size: 14px; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: #eef2ff; color:#243b8a; font-weight: 700; font-size: 13px; }
    .big { font-size: 20px; }
    .center { text-align: center; }
    .feedback { margin-top: 10px; padding: 12px; border-radius: 12px; border: 1px solid #e6e8f0; background:#fafbff; }
    .good { border-color: #bfe8c8; background:#f1fbf3; }
    .bad { border-color: #f3c2c2; background:#fff4f4; }
    .hidden { display: none !important; }
    .btnrow { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .list { margin: 8px 0 0; padding-left: 18px; }
    .small { font-size: 14px; }
    .topspace { margin-top: 14px; }
    code { background: #f1f3fb; padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="setupCard">
      <h1>Moon spelling practice</h1>
      <div class="muted">
        Pick a kid, a week (from <b>INDEX</b>), and a mode. Tap <b>Start</b> to unlock audio on iPhone/iPad.
      </div>

    <!-- Sheet ID hidden for kid mode -->
    <input id="sheetId" type="hidden" />


      <div class="row2">
        <div>
          <label>Kid</label>
          <select id="kidSelect">
            <option value="">Paste Sheet ID firstâ€¦</option>
          </select>
        </div>
        <div>
          <label>Week</label>
          <select id="weekSelect" disabled>
            <option value="">Select a kid firstâ€¦</option>
          </select>
          <div class="muted small">Active weeks only, <b>newest first</b>.</div>
        </div>
      </div>

      <label>Mode</label>
      <select id="modeSelect">
        <option value="quick">Quick Quiz</option>
        <option value="practice_test">Practice â†’ Test</option>
        <option value="mastery">Mastery Loop</option>
      </select>

      <!-- Voice Selector -->
      <label>Voice</label>
      <select id="voiceSelect"></select>

      <div class="row topspace">
        <button class="primary big" id="startBtn">Start</button>
      </div>

      <details class="topspace">
        <summary class="muted">Optional: Manual tab override (if INDEX wonâ€™t load)</summary>
        <label>Manual tab name</label>
        <input id="manualTab" placeholder="Exact tab name, e.g., Ella_2026-01-19" />
        <div class="muted small">If you enter this, it overrides the kid/week dropdowns.</div>
      </details>

      <details class="topspace">
        <summary class="muted">Sheet requirements (what tabs do I need?)</summary>
        <div class="muted small">
          You need:
          <ul class="list">
            <li>An <b>INDEX</b> tab with columns: <code>tab</code>, <code>kid</code>, <code>week_label</code>, <code>week_date</code>, <code>active</code>.</li>
            <li>One or more vocab tabs named exactly as <code>tab</code> values in INDEX.</li>
            <li>Each vocab tab needs a header <code>word</code> in A1, then words below it.</li>
          </ul>
        </div>
      </details>

      <details class="topspace">
        <summary class="muted">Where do I find the Sheet ID?</summary>
        <div class="muted small">
          In a Google Sheets URL like:<br/>
          <code>https://docs.google.com/spreadsheets/d/<b>SHEET_ID</b>/edit</code>
        </div>
      </details>
    </div>

    <div class="card hidden" id="gameCard">
      <div class="row">
        <div class="row2">
          <div><span class="pill" id="modePill">Mode</span></div>
          <div class="center muted" id="progressText"></div>
        </div>

        <div class="btnrow">
          <button class="secondary big" id="repeatBtn">ðŸ”Š Repeat</button>
          <button class="secondary big" id="skipBtn">Skip</button>
        </div>

        <label>Type the spelling</label>
        <input id="answer" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="Type hereâ€¦" />

        <div class="btnrow">
          <button class="primary big" id="submitBtn">Submit</button>
          <button class="secondary big" id="endBtn">End</button>
        </div>

        <div id="feedback" class="feedback hidden"></div>
      </div>
    </div>

    <div class="card hidden" id="resultsCard">
      <h2>Results</h2>
      <div id="resultsSummary" class="muted"></div>
      <div id="resultsDetail" class="topspace"></div>
      <div class="row topspace">
        <button class="primary big" id="backBtn">Back to start</button>
      </div>
    </div>
  </div>

<script>
  // ===== YOUR GOOGLE SHEET =====
  const HARDCODED_SHEET_ID = "1Nk7vOTqTiBJLPyn2jSlbxLb23RaWMmlaqnn7JRG1frk";

  // ---------- Utilities ----------
  function normalize(s) {
    return (s ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, ""); // ignore spaces
  }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll">", "&gt;")
      .replaceAll("\"", "&quot;")
      .replaceAll("'", "&#039;");
  }

  function csvUrl(sheetId, tabName) {
    // Public sheet CSV export via gviz endpoint
    const base = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheetId)}/gviz/tq?tqx=out:csv`;
    // Append unique timestamp to prevent caching
    const cacheBuster = new Date().getTime();
    return `${base}&sheet=${encodeURIComponent(tabName)}&_cacheBust=${cacheBuster}`;
  }

  async function fetchCsvRows(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
    const text = await res.text();
    return parseCsv(text);
  }

  // Minimal CSV parser that handles quoted cells
  function parseCsv(text) {
    const rows = [];
    let row = [];
    let cell = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (c === '"') {
        if (inQuotes && next === '"') { cell += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (c === ',' && !inQuotes) {
        row.push(cell); cell = "";
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (c === '\r' && next === '\n') i++;
        row.push(cell);
        if (row.length > 1 || row[0].trim() !== "") rows.push(row);
        row = []; cell = "";
      } else {
        cell += c;
      }
    }

    if (cell.length || row.length) {
      row.push(cell);
      if (row.length > 1 || row[0].trim() !== "") rows.push(row);
    }
    return rows;
  }

  // ---------- Speech ----------
  let selectedVoice = null;

  function initVoices() {
    return new Promise((resolve) => {
      const tryResolve = () => {
        const voices = speechSynthesis.getVoices();
        if (voices && voices.length) {
          populateVoiceSelector(voices);
          resolve();
          return true;
        }
        return false;
      };
      if (tryResolve()) return;
      speechSynthesis.onvoiceschanged = () => { if (tryResolve()) resolve(); };
    });
  }

  function populateVoiceSelector(voices) {
    const voiceSelectEl = document.getElementById("voiceSelect");
    voiceSelectEl.innerHTML = voices.map((voice, i) => {
      return `<option value="${i}">${voice.name} (${voice.lang})</option>`;
    }).join("");

    // Try to select default voice
    const defaultVoiceIndex = voices.findIndex(v => (v.lang || "").toLowerCase().startsWith("en") && 
      (v.name.includes("Samantha") || v.name.includes("Fred") || v.name.includes("Karen") || 
      v.name.includes("Premium") || v.name.includes("Enhanced")));

    if (defaultVoiceIndex !== -1) {
      voiceSelectEl.selectedIndex = defaultVoiceIndex;
      selectedVoice = voices[defaultVoiceIndex];
    }

    // Listen for changes to the select element
    voiceSelectEl.addEventListener("change", () => {
      selectedVoice = voices[parseInt(voiceSelectEl.value)] || null;
    });
  }

  function speak(text) {
    try {
      speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      if (selectedVoice) {
        utter.voice = selectedVoice;
      }
      utter.rate = 0.8; // Slightly slower for clarity
      utter.pitch = 1.0;
      speechSynthesis.speak(utter);
    } catch (e) {
      // ignore
    }
  }

  // ... remaining code remains the same, unchanged
  });